/*  js-model JavaScript library, version 0.8.0
 *  (c) 2010 Ben Pickles
 *
 *  Released under MIT license.
 */
var Model=function(a,d,e){d=jQuery.extend(d,{load:function(c){this.persistence.index(c)}});e=e||{};var b=function(c){this.attributes=c||{};this.callbacks={};this.changes={};this.errors=new Model.Errors(this)};jQuery.extend(b,Model.Collection(),d,{_name:a});jQuery.extend(b.prototype,Model.InstanceMethods,e);return b};Model.Collection=function(){var a=function(d){this.collection=d||[];this.callbacks={}};jQuery.extend(a.prototype,Model.CollectionMethods,{chain:function(d){return new a(d)}});return new a};
Model.CollectionMethods={add:function(){for(var a=[],d=0;d<arguments.length;d++){var e=arguments[d];if(!this.detect(function(){return this.id()!=null&&this.id()==e.id()})){this.collection.push(e);a.push(e)}}a.length>0&&this.trigger("add",a);return this},all:function(){return this.collection},bind:function(a,d){this.callbacks[a]=this.callbacks[a]||[];this.callbacks[a].push(d);return this},count:function(){return this.collection.length},detect:function(a){var d;$.each(this.all(),function(e){if(a.call(this,
e)){d=this;return false}});return d},each:function(a){jQuery.each(this.all(),function(d){a.call(this,d)});return this},find:function(a){return this.detect(function(){return this.id()==a})},first:function(){return this.all()[0]||null},last:function(){var a=this.all();return a[a.length-1]||null},remove:function(a){var d=_.invoke(this.collection,"id");a=_.indexOf(d,a);if(a>-1){this.collection.splice(a,1);this.trigger("remove");return true}else return false},select:function(a){var d=[];$.each(this.all(),
function(e){a.call(this,e)&&d.push(this)});return this.chain(d)},sort:function(a){return this.chain(_.sortBy(this.all(),function(d,e){return a.call(d,e)}))},trigger:function(a,d){if(a=this.callbacks[a])for(var e=0;e<a.length;e++)a[e].apply(this,d||[]);return this}};Model.Errors=function(a){this.errors={};this.model=a};
Model.Errors.prototype={add:function(a,d){this.errors[a]||(this.errors[a]=[]);this.errors[a].push(d)},all:function(){return this.errors},clear:function(){this.errors={}},each:function(a){for(var d in this.errors)for(var e=0;e<this.errors[d].length;e++)a.call(this,d,this.errors[d][e])},on:function(a){return this.errors[a]||[]},size:function(){var a=0;this.each(function(){a++});return a}};
Model.InstanceMethods={attr:function(a,d){if(arguments.length==0)return jQuery.extend({},this.attributes,this.changes);else if(arguments.length==2){if(_.isEqual(this.attributes[a],d))delete this.changes[a];else this.changes[a]=d;return this}else if(typeof a=="object"){for(var e in a)this.attr(e,a[e]);return this}else return a in this.changes?this.changes[a]:this.attributes[a]},bind:function(a,d){this.callbacks[a]=this.callbacks[a]||[];this.callbacks[a].push(d);return this},callPersistMethod:function(a,
d){var e=this,b=function(){if(a=="create")e.constructor.add(e);else a=="destroy"&&e.constructor.remove(e.id())},c=function(f){if(f){e.merge(e.changes).reset();b();e.trigger(a)}var g;if(d)g=d.apply(e,arguments);return g};this.constructor.persistence?this.constructor.persistence[a](this,c):c.call(this,true)},destroy:function(a){this.callPersistMethod("destroy",a);return this},id:function(){return this.attributes.id||null},merge:function(a){jQuery.extend(this.attributes,a);return this},newRecord:function(){return this.id()==
null},reset:function(){this.errors.clear();this.changes={};return this},save:function(a){if(this.valid())this.callPersistMethod(this.newRecord()?"create":"update",a);else a&&a(false);return this},toString:function(){return JSON.stringify(this.attr())},trigger:function(a,d){if(a=this.callbacks[a])for(var e=0;e<a.length;e++)a[e].apply(this,d||[]);return this},update:function(a){this.merge(a).trigger("update");return this},valid:function(){this.errors.clear();this.validate();return this.errors.size()==
0},validate:function(){return this}};Model.Log=function(){window.console&&window.console.log.apply(window.console,arguments)};
Model.RestPersistence=function(a,d){var e=function(){this.resource=a};jQuery.extend(e.prototype,{create:function(b,c){return this.xhr("POST",this.create_path(b),b,c)},create_path:function(){return this.resource},destroy:function(b,c){return this.xhr("DELETE",this.destroy_path(b),b,c)},destroy_path:function(b){return this.update_path(b)},params:function(b){var c;if(b){var f=b.attr();delete f.id;c={};c[b.constructor._name.toLowerCase()]=f}else c=null;return c},parseResponseData:function(b){try{return jQuery.parseJSON(b.responseText)}catch(c){Model.Log(c)}},
update:function(b,c){return this.xhr("PUT",this.update_path(b),b,c)},update_path:function(b){return[this.resource,b.id()].join("/")},xhr:function(b,c,f,g){var h=this,i=b=="DELETE"?null:this.params(f);return jQuery.ajax({type:b,url:c,dataType:"text",data:i,complete:function(j,k){h.xhrComplete(j,k,f,g)}})},xhrComplete:function(b,c,f,g){var h=this.parseResponseData(b);c=c=="success";if(h)if(c)f.attr(h);else if(b.status==422){f.errors.clear();for(var i in h)for(var j=0;j<h[i].length;j++)f.errors.add(i,
h[i][j])}g&&g.call(f,c,b)}},d);return new e};
Model.LocalStorage=function(a,d){var e=function(){this.modelName=a;this.supported=function(){return!!window.localStorage}};e.prototype=$.extend({create:function(b,c){if(this.supported()){this.store(b);c&&c.call(b,true,{});return true}else this.goBang()},destroy:function(b,c){if(this.supported()){localStorage.removeItem(this.generateKey(b));c&&c.call(b,true,{});return true}else this.goBang()},generateId:function(){var b=localStorage.getItem("ids")||0;b++;localStorage.setItem("ids",b);return b},generateKey:function(b){return[this.modelName,
b.id()].join("_")},goBang:function(){throw new Error("Your browser doesn't support localStorage");},index:function(b){if(this.supported())for(var c=localStorage.length;c--;){if(localStorage.key(c).match(this.modelName)){var f=JSON.parse(localStorage[localStorage.key(c)]);b&&b.call(f)}}else this.goBang()},store:function(b){if(b.newRecord())b.attributes.id=this.generateId();localStorage.setItem(this.generateKey(b),b.toString())},update:function(b,c){if(this.supported()){this.store(b);c&&c.call(b,true,
{});return true}else this.goBang()}},d);return new e};
Model.RackJSONPersistence=function(a,d){var e=function(){this.resource=a};jQuery.extend(e.prototype,{create:function(b,c){return this.xhr("POST",this.create_path(b),b,c)},create_path:function(){return this.resource},destroy:function(b,c){return this.xhr("DELETE",this.destroy_path(b),b,c)},destroy_path:function(b){return this.update_path(b)},parseResponseData:function(b){try{return jQuery.parseJSON(b.responseText)}catch(c){Model.Log(c)}},update:function(b,c){return this.xhr("PUT",this.update_path(b),
b,c)},update_path:function(b){return[this.resource,b.id()].join("/")},xhr:function(b,c,f,g){var h=this,i=b==="DELETE"?null:f.toString();return jQuery.ajax({type:b,url:c,dataType:"json",data:i,complete:function(j,k){h.xhrComplete(j,k,f,g)}})},xhrComplete:function(b,c,f,g){var h=this.parseResponseData(b);c=c==="success";if(h)if(c)f.attr(h);else b.status===422&&Model.log("invalid json document");g&&g.call(f,c,b)}},d);return new e};
